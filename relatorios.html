<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatórios de Ponto</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    tr:hover { background-color: #f1f1f1; cursor: pointer; }

    /* Popup */
    .popup {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .popup-content {
      background: white;
      padding: 20px;
      margin: 10% auto;
      width: 300px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .close-btn {
      float: right;
      cursor: pointer;
      color: red;
      font-weight: bold;
    }
    .export-btn {
      margin-top: 10px;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  
  <h1>Relatórios de Ponto</h1>
    
  <button onclick="window.location.href='inicio.html'">Inicio</button>
  <button id="exportBtn" class="export-btn">Exportar para Excel (CSV)</button>
  
  <table id="registrosTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>Data</th>
        <th>Hora</th>
        <th>Localização</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Popup -->
  <div id="popup" class="popup">
    <div class="popup-content">
      <span id="closePopup" class="close-btn">&times;</span>
      <h3>Detalhes do Registro</h3>
      <p id="popupEmail"></p>
      <p id="popupData"></p>
      <p id="popupHora"></p>
      <p id="popupLocal"></p>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';

    const tableBody = document.querySelector("#registrosTable tbody");
    const popup = document.getElementById("popup");
    const closePopup = document.getElementById("closePopup");

    const popupEmail = document.getElementById("popupEmail");
    const popupData = document.getElementById("popupData");
    const popupHora = document.getElementById("popupHora");
    const popupLocal = document.getElementById("popupLocal");

    const exportBtn = document.getElementById("exportBtn");

    let registros = [];

    async function carregarRegistros() {
      const { data, error } = await supabase
        .from('registros')
        .select('email, horario, localidade')
        .order('horario', { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      registros = data;
      renderTable();
    }

    function renderTable() {
      tableBody.innerHTML = "";
      registros.forEach((reg, index) => {
        const dataObj = new Date(reg.horario);
        const data = dataObj.toLocaleDateString();
        const hora = dataObj.toLocaleTimeString();

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${reg.email}</td>
          <td>${data}</td>
          <td>${hora}</td>
          <td>${reg.localidade}</td>
        `;
        row.addEventListener("click", () => abrirPopup(index));
        tableBody.appendChild(row);
      });
    }

    function abrirPopup(index) {
      const reg = registros[index];
      const dataObj = new Date(reg.horario);
      popupEmail.textContent = `Email: ${reg.email}`;
      popupData.textContent = `Data: ${dataObj.toLocaleDateString()}`;
      popupHora.textContent = `Hora: ${dataObj.toLocaleTimeString()}`;
      popupLocal.textContent = `Localização: ${reg.localidade}`;
      popup.style.display = "block";
    }

    closePopup.addEventListener("click", () => {
      popup.style.display = "none";
    });

    window.addEventListener("click", (e) => {
      if (e.target === popup) popup.style.display = "none";
    });

    exportBtn.addEventListener("click", () => {
      let csv = "Email;Data;Hora;Localização\n";
      registros.forEach(r => {
        const dataObj = new Date(r.horario);
        const data = dataObj.toLocaleDateString();
        const hora = dataObj.toLocaleTimeString();
        csv += `${r.email};${data};${hora};${r.localidade}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "relatorio_ponto.csv";
      link.click();
    });

    carregarRegistros();
  </script>
</body>
</html>
